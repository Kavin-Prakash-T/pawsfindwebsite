<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PawsFind - Find Your Perfect Pet</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <nav>
            <div class="logo">PawsFind</div>
            <div class="nav-links">
                <a href="index.html" class="active">Home</a>
                <a href="pets.html">Available Pets</a>
                <a href="my-applications.html">My Applications</a>
                <a href="#" id="logout">Logout</a>
            </div>
        </nav>
    </header>

    <main>
        <section class="hero">
            <h1>Find Your Perfect Companion</h1>
            <p>Give a loving home to a pet in need</p>
        </section>

        <section class="filters">
            <h2>Find Your Perfect Match</h2>
            <div class="filter-container">
                <div class="filter-group">
                    <label for="type">Pet Type</label>
                    <select id="type">
                        <option value="">All Types</option>
                        <option value="dog">Dog</option>
                        <option value="cat">Cat</option>
                        <option value="bird">Bird</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="size">Size</label>
                    <select id="size">
                        <option value="">All Sizes</option>
                        <option value="small">Small</option>
                        <option value="medium">Medium</option>
                        <option value="large">Large</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="gender">Gender</label>
                    <select id="gender">
                        <option value="">All Genders</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="age">Age</label>
                    <select id="age">
                        <option value="">All Ages</option>
                        <option value="0-1">Under 1 year</option>
                        <option value="1-3">1-3 years</option>
                        <option value="3-5">3-5 years</option>
                        <option value="5+">5+ years</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="neutered">Neutered</label>
                    <select id="neutered">
                        <option value="">All</option>
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="search">Search</label>
                    <input type="text" id="search" placeholder="Search by name or breed">
                </div>
            </div>
        </section>

        <section class="pets-grid" id="petsGrid">
            <!-- Pet cards will be dynamically added here -->
        </section>

        <!-- Pet Details Modal -->
        <div class="modal" id="petModal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <div class="pet-details">
                    <div class="pet-image">
                        <img id="modalPetImage" src="" alt="Pet Image">
                    </div>
                    <div class="pet-info">
                        <h2 id="modalPetName"></h2>
                        <div class="pet-stats">
                            <span id="modalPetType"></span>
                            <span id="modalPetBreed"></span>
                            <span id="modalPetAge"></span>
                        </div>
                        <p id="modalPetDescription"></p>
                        <div class="shelter-info">
                            <h3>Shelter Information</h3>
                            <p id="modalShelterName"></p>
                            <p id="modalShelterLocation"></p>
                        </div>
                        <div class="pet-tags" id="modalPetTags"></div>
                        <button class="apply-button" id="applyButton">Apply for Adoption</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2024 PawsFind. All rights reserved.</p>
    </footer>

    <script>
        const API_BASE_URL = 'http://localhost:8000/api';
        let currentPets = [];
        let isLoadingPets = false;
        const imageCache = new Map();

        // Function to fetch and cache image
        async function fetchAndCacheImage(url) {
            if (imageCache.has(url)) {
                return imageCache.get(url);
            }

            try {
                const response = await fetch(url, {
                    headers: {
                        'Cache-Control': 'public, max-age=3600' // Cache for 1 hour
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch image');
                
                const blob = await response.blob();
                const imageURL = URL.createObjectURL(blob);
                imageCache.set(url, imageURL);
                return imageURL;
            } catch (error) {
                console.error('Error fetching image:', error);
                return 'images/pet-placeholder.jpg';
            }
        }

        // Function to handle image loading with caching
        async function loadImage(img, imageUrl) {
            try {
                const cachedUrl = await fetchAndCacheImage(imageUrl);
                img.src = cachedUrl;
            } catch (error) {
                console.error('Error loading image:', error);
                img.src = 'images/pet-placeholder.jpg';
            }
        }

        // Check if user is logged in
        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }

            try {
                // Verify token by making a request to a protected endpoint
                const response = await fetch(`${API_BASE_URL}/pets/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Invalid token');
                }
                return true;
            } catch (error) {
                console.error('Auth error:', error);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
                return false;
            }
        }

        // Fetch pets from the API
        async function fetchPets() {
            if (isLoadingPets) return;
            isLoadingPets = true;

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = 'login.html';
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/pets/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch pets');
                }

                const pets = await response.json();
                console.log('Fetched pets:', pets); // Debug log
                currentPets = pets;
                displayPets(pets);
            } catch (error) {
                console.error('Error fetching pets:', error);
                showError('Failed to load pets. Please try again later.');
            } finally {
                isLoadingPets = false;
            }
        }

        // Show error message
        function showError(message) {
            const grid = document.getElementById('petsGrid');
            grid.innerHTML = `<div class="error-message">${message}</div>`;
        }

        // Display pets in the grid
        async function displayPets(pets) {
            const grid = document.getElementById('petsGrid');
            grid.innerHTML = '';

            if (!pets || pets.length === 0) {
                grid.innerHTML = '<p class="no-pets">No pets found matching your criteria.</p>';
                return;
            }

            const fragment = document.createDocumentFragment();

            for (const pet of pets) {
                console.log('Processing pet:', pet); // Debug log
                const card = document.createElement('div');
                card.className = 'pet-card';
                
                const imgContainer = document.createElement('div');
                imgContainer.className = 'pet-image';
                const img = document.createElement('img');
                img.alt = pet.name;
                img.loading = 'lazy';
                
                if (pet.image) {
                    // Check if the image URL is a base64 string
                    if (pet.image.startsWith('data:image')) {
                        img.src = pet.image;
                    } else {
                        // Use the provided image URL
                        const imageUrl = pet.image;
                        console.log('Loading image from:', imageUrl); // Debug log
                        await loadImage(img, imageUrl);
                    }
                } else {
                    // If no image specified, use a default based on pet type
                    const defaultImage = pet.type === 'cat' ? 'cat1.jpeg' : 'dog1.jpeg';
                    const imageUrl = `http://127.0.0.1:8000/media/${defaultImage}`;
                    console.log('Using default image:', imageUrl); // Debug log
                    await loadImage(img, imageUrl);
                }
                
                imgContainer.appendChild(img);
                
                const infoContainer = document.createElement('div');
                infoContainer.className = 'pet-info';
                infoContainer.innerHTML = `
                    <h3>${pet.name}</h3>
                    <div class="pet-stats">
                        <span>${pet.type}</span>
                        <span>${pet.breed}</span>
                        <span>${pet.age} years</span>
                    </div>
                    <p>${pet.description ? pet.description.substring(0, 100) + (pet.description.length > 100 ? '...' : '') : ''}</p>
                    <button class="view-details" data-pet-id="${pet._id}">View Details</button>
                `;
                
                card.appendChild(imgContainer);
                card.appendChild(infoContainer);
                fragment.appendChild(card);
            }

            grid.appendChild(fragment);

            document.querySelectorAll('.view-details').forEach(button => {
                button.addEventListener('click', () => showPetDetails(button.dataset.petId));
            });
        }

        // Show pet details in modal
        async function showPetDetails(petId) {
            const pet = currentPets.find(p => p._id === petId);
            if (!pet) return;

            const modalImg = document.getElementById('modalPetImage');
            modalImg.loading = 'lazy';
            
            if (pet.image) {
                // Check if the image URL is a base64 string
                if (pet.image.startsWith('data:image')) {
                    modalImg.src = pet.image;
                } else {
                    // Use the provided image URL
                    const imageUrl = pet.image;
                    console.log('Loading modal image from:', imageUrl); // Debug log
                    await loadImage(modalImg, imageUrl);
                }
            } else {
                // If no image specified, use a default based on pet type
                const defaultImage = pet.type === 'cat' ? 'cat1.jpeg' : 'dog1.jpeg';
                const imageUrl = `http://127.0.0.1:8000/media/${defaultImage}`;
                console.log('Using default modal image:', imageUrl); // Debug log
                await loadImage(modalImg, imageUrl);
            }

            document.getElementById('modalPetName').textContent = pet.name;
            document.getElementById('modalPetType').textContent = `Type: ${pet.type}`;
            document.getElementById('modalPetBreed').textContent = `Breed: ${pet.breed}`;
            document.getElementById('modalPetAge').textContent = `Age: ${pet.age} years`;
            document.getElementById('modalPetDescription').textContent = pet.description;
            document.getElementById('modalShelterName').textContent = `Shelter: ${pet.shelter_name}`;
            document.getElementById('modalShelterLocation').textContent = `Location: ${pet.shelter_location}`;

            const tagsContainer = document.getElementById('modalPetTags');
            tagsContainer.innerHTML = '';
            if (pet.tags && Array.isArray(pet.tags)) {
                pet.tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'tag';
                    tagElement.textContent = tag;
                    tagsContainer.appendChild(tagElement);
                });
            }

            document.getElementById('applyButton').onclick = () => applyForAdoption(pet._id);
            document.getElementById('petModal').style.display = 'block';
        }

        // Apply for adoption
        async function applyForAdoption(petId) {
            try {
                const response = await fetch(`${API_BASE_URL}/applications/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pet_id: petId,
                        notes: 'I would love to adopt this pet!'
                    })
                });

                if (!response.ok) throw new Error('Failed to submit application');

                alert('Application submitted successfully!');
                document.getElementById('petModal').style.display = 'none';
            } catch (error) {
                console.error('Error submitting application:', error);
                alert('Failed to submit application. Please try again later.');
            }
        }

        // Filter pets
        function filterPets() {
            const type = document.getElementById('type').value;
            const size = document.getElementById('size').value;
            const gender = document.getElementById('gender').value;
            const age = document.getElementById('age').value;
            const neutered = document.getElementById('neutered').value;
            const search = document.getElementById('search').value.toLowerCase();

            let filteredPets = [...currentPets]; // Create a copy of current pets

            if (type) filteredPets = filteredPets.filter(pet => pet.type === type);
            if (size) filteredPets = filteredPets.filter(pet => pet.size === size);
            if (gender) filteredPets = filteredPets.filter(pet => pet.gender === gender);
            if (neutered) filteredPets = filteredPets.filter(pet => pet.neutered === (neutered === 'true'));
            if (search) {
                filteredPets = filteredPets.filter(pet => 
                    pet.name.toLowerCase().includes(search) || 
                    pet.breed.toLowerCase().includes(search)
                );
            }
            if (age) {
                const [min, max] = age.split('-').map(Number);
                filteredPets = filteredPets.filter(pet => {
                    if (max) return pet.age >= min && pet.age <= max;
                    return pet.age >= min;
                });
            }

            displayPets(filteredPets);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                await fetchPets();
            }

            const filterInputs = ['type', 'size', 'gender', 'age', 'neutered', 'search'];
            filterInputs.forEach(inputId => {
                const element = document.getElementById(inputId);
                if (element) {
                    element.addEventListener('change', filterPets);
                }
            });

            document.querySelector('.close').addEventListener('click', () => {
                document.getElementById('petModal').style.display = 'none';
            });

            window.addEventListener('click', (event) => {
                const modal = document.getElementById('petModal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });

            document.getElementById('logout').addEventListener('click', (e) => {
                e.preventDefault();
                // Revoke all object URLs to prevent memory leaks
                imageCache.forEach(url => URL.revokeObjectURL(url));
                imageCache.clear();
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            });
        });
    </script>
</body>
</html>